pkgname=screen-git-term
pkgver=398.b8d11d7
pkgrel=1
pkgdesc="GNU Screen package with everything"
arch=(i686 x86_64)
provides=('screen' 'screen-vs' 'screen-git' 'screen-best')
conflicts=('screen' 'screen-vs' 'screen-git' 'screen-best')
depends=(ncurses pam)
makedepends=(git automake autoconf)
url=http://www.gnu.org/software/screen/
license=GPL
backup=(etc/screenrc etc/pam.d/screen)
options=('!makeflags')
source=(
	 'git://git.savannah.gnu.org/screen.git'
	 'https://projects.archlinux.org/svntogit/packages.git/plain/screen/trunk/screen-4.0.3-long-term.patch'
)
md5sums=(
	 'SKIP'
	 '2723c3e71d5a2e5a74b6ddbc5215ef0f'
)

pkgver() {
	 cd "${srcdir}/screen"
	 local ver="$(git rev-list --count HEAD).$(git rev-parse --short HEAD)"
	 printf "%s" "${ver//-/.}"
}

prepare() {
	 cd "${srcdir}/screen/src"
	 patch -Np1 -i "${srcdir}"/screen-4.0.3-long-term.patch
	 ./autogen.sh
	 ./configure \
		  --prefix=/usr \
		  --enable-pam \
		  --enable-colors256 \
		  --enable-rxvt_osc \
		  --enable-telnet \
		  --with-pty-group=5 \
		  --with-sys-screenrc=/etc/screenrc \
		  --mandir=/usr/share/man \
		  --with-socket-dir=/run/screens \
		  --infodir=/usr/share/info
}
build() {
	 cd "${srcdir}/screen/src"
	 ionice -c 3 nice -n 19 make
}
package() {
	 cd "${srcdir}/screen/src"
	 make DESTDIR=$pkgdir install
	 mkdir -p $pkgdir/etc/pam.d
	 echo 'auth		required	pam_unix.so' > $pkgdir/etc/pam.d/screen
	 chmod u-s $pkgdir/usr/bin/screen-4.1.0

	 rm ${pkgdir}/usr/share/info/dir
	 gzip -9 ${pkgdir}/usr/share/info/*
}
